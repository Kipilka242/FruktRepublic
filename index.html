<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Maps & Panoramas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    
    <style>
        :root { 
            --google-blue: #1a73e8; 
            --active-red: #d93025;
            --bg-light: #f8f9fa;
        }
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Roboto', Arial, sans-serif; }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –ö–∞—Ä—Ç–æ–π –∏ –ü–∞–Ω–æ—Ä–∞–º–æ–π */
        #main-container { display: flex; height: 100%; width: 200%; transition: transform 0.5s ease-in-out; }
        #main-container.show-pano { transform: translateX(-50%); }
        
        .view-section { width: 50%; height: 100%; position: relative; }
        
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–∞—Ä—Ç—ã */
        #map-ui { position: absolute; top: 10px; left: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .gm-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); padding: 8px; display: flex; align-items: center; }
        .search-box { width: 320px; height: 40px; padding: 0 15px; border: none; font-size: 16px; outline: none; }

        .set-start-btn {
            width: 48px; height: 48px; background: white; border: none; border-radius: 50%;
            cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease; font-size: 22px; outline: none;
        }
        .set-start-btn.active { background: var(--google-blue); color: white; animation: pulse 1.5s infinite; }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(26, 115, 232, 0); }
            100% { box-shadow: 0 0 0 0 rgba(26, 115, 232, 0); }
        }

        /* –ü–∞–Ω–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞ */
        #route-panel { position: absolute; top: 75px; left: 10px; z-index: 1000; width: 336px; background: white; border-radius: 8px; display: none; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #route-info { font-size: 15px; font-weight: 500; color: #3c4043; margin-bottom: 8px; }
        
        .btn-pano-switch { position: absolute; bottom: 30px; right: 30px; z-index: 1000; background: var(--google-blue); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –≤ –ø–∞–Ω–æ—Ä–∞–º–∞—Ö */
        #topbar-pano {
            position: absolute; top: 0; left: 0; right: 0; height: 45px;
            background: rgba(0,0,0,0.7); color: #fff; display: flex;
            align-items: center; padding: 0 10px; z-index: 10;
        }
        #topbar-pano select { margin-left: 8px; padding: 3px; cursor: pointer; }
        
        #panorama { width: 100%; height: 100%; background: #000; }
        #map { width: 100%; height: 100%; background: var(--bg-light); }
    </style>
</head>
<body>

<script src="data.js"></script>

<div id="main-container">
    <div class="view-section" id="section-map">
        <div id="map-ui">
            <div class="gm-card">
                <input type="text" id="mapSearch" class="search-box" placeholder="–ü–æ–∏—Å–∫ –≤ Minecraft (–Ω–∞–∂–º–∏—Ç–µ Enter)...">
            </div>
            <button id="toggleMarkerBtn" class="set-start-btn" onclick="toggleSelectionMode()" title="–í—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è">üìç</button>
        </div>

        <div id="route-panel">
            <div style="font-size: 11px; color: var(--google-blue); font-weight: bold; text-transform: uppercase; margin-bottom: 4px;">–ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</div>
            <div id="route-info"></div>
            <button onclick="clearRoute()" style="border:none; background:none; color:var(--active-red); cursor:pointer; font-weight:500; padding:0;">–£–¥–∞–ª–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
        </div>

        <div id="map"></div>
        <button class="btn-pano-switch" onclick="switchTo('panoram')">–ü–∞–Ω–æ—Ä–∞–º—ã</button>
    </div>

    <div class="view-section" id="section-pano">
        <div id="topbar-pano">
            <button onclick="switchTo('map')" style="background:white; border:none; padding:5px 12px; border-radius:4px; cursor:pointer; font-weight:bold; margin-right:15px;">‚¨Ö –ù–∞–∑–∞–¥ –∫ –∫–∞—Ä—Ç–µ</button>
            <span>–õ–æ–∫–∞—Ü–∏—è:</span>
            <select id="locationSelect"></select>
        </div>
        <div id="panorama"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

<script>
    // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –î–ê–ù–ù–´–ï
    const PANO_SCENES = [
        { id: 'meriya', title: '–ú–µ—Ä–∏—è', folder: '–ú–µ—Ä–∏—è' },
        { id: 'zhd', title: '–ñ–î-–°—Ç–∞–Ω—Ü–∏—è', folder: '–ñ–î-–°—Ç–∞–Ω—Ü–∏—è' },
        { id: 'ferma_sani', title: '–§–µ—Ä–º–∞ –°–∞–Ω–∏', folder: '–§–µ—Ä–º–∞ –°–∞–Ω–∏' },
        { id: 'ferma_ariny', title: '–§–µ—Ä–º–∞ –ê—Ä–∏–Ω—ã', folder: '–§–µ—Ä–º–∞ –ê—Ä–∏–Ω—ã' },
        { id: 'most', title: '–ú–æ—Å—Ç –Ω–∞–¥ –æ–∑–µ—Ä–æ–º', folder: '–ú–æ—Å—Ç –Ω–∞–¥ –æ–∑–µ—Ä–æ–º' },
        { id: 'ozero', title: '–û–∑–µ—Ä–æ', folder: '–û–∑–µ—Ä–æ' },
        { id: 'les', title: '–õ–µ—Å', folder: '–õ–µ—Å' },
        { id: 'ploshad_larki', title: '–ü–ª–æ—â–∞–¥—å –ø–µ—Ä–µ–¥ –ª–∞—Ä—å–∫–∞–º–∏', folder: '–ü–ª–æ—â–∞–¥—å –ø–µ—Ä–µ–¥ –ª–∞—Ä—å–∫–∞–º–∏' },
        { id: 'istochnik', title: '–ò—Å—Ç–æ—á–Ω–∏–∫ –ë—É–ª—ã–∂–Ω–∏–∫–∞', folder: '–ò—Å—Ç–æ—á–Ω–∏–∫ –ë—É–ª—ã–∂–Ω–∏–∫–∞' },
        { id: 'kostyor', title: '–ö–æ—Å—Ç—ë—Ä', folder: '–ö–æ—Å—Ç—ë—Ä' },
        { id: 'kosti', title: '–ö–æ—Å—Ç–∏', folder: '–ö–æ—Å—Ç–∏' },
        { id: 'Polet', title: '–° –ø—Ç–∏—á—å–µ–≥–æ –ü–æ–ª—ë—Ç–∞', folder: '–° –ø—Ç–∏—á—å–µ–≥–æ –ü–æ–ª—ë—Ç–∞' },
        { id: 'bashnya', title: '–ë–∞—à–Ω—è –°–æ–±–æ—Ä–Ω–æ—Å—Ç–∏', folder: '–ë–∞—à–Ω—è –°–æ–±–æ—Ä–Ω–æ—Å—Ç–∏' },
        { id: 'koltso', title: '–ö–æ–ª—å—Ü–æ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ü–æ—Ä–æ—Å—è', folder: '–ö–æ–ª—å—Ü–æ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –ü–æ—Ä–æ—Å—è' },
        { id: 'flag', title: '–§–ª–∞–≥', folder: '–§–ª–∞–≥' },
        { id: 'dom_layma', title: '–î–æ–º –õ–∞–π–º–∞', folder: '–î–æ–º –õ–∞–π–º–∞' },
        { id: 'ofis_dorog', title: '–û—Ñ–∏—Å –î–æ—Ä–æ–≥ –§–†', folder: '–û—Ñ–∏—Å –î–æ—Ä–æ–≥ –§–†' },
        { id: 'ofis_mon', title: '–û—Ñ–∏—Å –ú–æ–Ω–∞—Ä—Ö–∏—Å—Ç–∞', folder: '–û—Ñ–∏—Å –ú–æ–Ω–∞—Ä—Ö–∏—Å—Ç–∞' },
        { id: 'vhod_meriya', title: '–í—Ö–æ–¥ –≤ –º–µ—Ä–∏—é', folder: '–í—Ö–æ–¥ –≤ –º–µ—Ä–∏—é' },
        { id: 'tsin', title: '–¶–∏–Ω', folder: '–¶–∏–Ω' }
    ];

    const myData = typeof mapData !== 'undefined' ? mapData : { type: "FeatureCollection", features: [] };
    let userStartPoint = [500, 500]; // –¢–æ—á–∫–∞ –ê –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    let startMarker = null, currentRoute = null, isSelectionMode = false, viewer = null;

    // 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´
    const map = L.map('map', { 
        crs: L.CRS.Simple, 
        minZoom: -2, 
        maxZoom: 3, 
        zoomControl: false,
        attributionControl: false 
    });
    map.setView(userStartPoint, 0);

    // –°—Ç–∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–≤
    const layerStyle = {
        water: { fillColor: '#aadaff', color: '#aadaff', weight: 1, fillOpacity: 0.8 },
        building: { fillColor: '#f1f3f4', color: '#dadce0', weight: 1, fillOpacity: 1 },
        road: { color: '#ffffff', weight: 5, opacity: 1 },
        roadCase: { color: '#e8eaed', weight: 9, opacity: 1 }
    };

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–æ—Ä–æ–≥ (–Ω–∏–∂–Ω–∏–π —Å–ª–æ–π)
    L.geoJSON(myData, { 
        filter: f => f.properties.mcType === 'road', 
        style: layerStyle.roadCase, 
        interactive: false 
    }).addTo(map);

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤
    L.geoJSON(myData, {
        style: f => layerStyle[f.properties.mcType] || {},
        onEachFeature: (f, l) => {
            if (f.properties.name && f.properties.name !== ".") {
                const c = getCentroid(f);
                l.bindPopup(`
                    <div style="text-align:center; font-family: sans-serif;">
                        <b style="font-size:14px;">${f.properties.name}</b><br>
                        <button onclick="buildRealRoute(${c[0]}, ${c[1]}, '${f.properties.name}')" 
                                style="background:var(--google-blue); color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:10px; width:100%;">
                            –ü—Ä–æ–ª–æ–∂–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
                        </button>
                    </div>
                `);
            } else {
                l.setStyle({ opacity: 0, fillOpacity: 0 });
            }
        }
    }).addTo(map);

    // 3. –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê
    window.toggleSelectionMode = function() {
        isSelectionMode = !isSelectionMode;
        const btn = document.getElementById('toggleMarkerBtn');
        btn.classList.toggle('active', isSelectionMode);
        document.getElementById('map').style.cursor = isSelectionMode ? "crosshair" : "";
    };

    window.switchTo = function(mode) {
        const container = document.getElementById('main-container');
        if (mode === 'panoram') {
            container.classList.add('show-pano');
            if (!viewer) loadScene(PANO_SCENES[0].id);
        } else {
            container.classList.remove('show-pano');
            // –í–∞–∂–Ω–æ: –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ "—Å–ª–æ–º–∞–ª–∞—Å—å" –ø–æ—Å–ª–µ —Å–¥–≤–∏–≥–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            setTimeout(() => { map.invalidateSize(); }, 500);
        }
    };

    window.clearRoute = function() {
        if (currentRoute) map.removeLayer(currentRoute);
        document.getElementById('route-panel').style.display = 'none';
    };

    // –°–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
    map.on('click', (e) => {
        if (isSelectionMode) {
            userStartPoint = [e.latlng.lat, e.latlng.lng];
            if (startMarker) {
                startMarker.setLatLng(e.latlng);
            } else {
                startMarker = L.marker(e.latlng, { 
                    icon: L.icon({ 
                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/1673/1673188.png', 
                        iconSize: [32, 32], 
                        iconAnchor: [16, 32] 
                    }) 
                }).addTo(map);
            }
            window.toggleSelectionMode();
        }
    });

    // 4. –õ–û–ì–ò–ö–ê –ú–ê–†–®–†–£–¢–û–í (DIJKSTRA)
    window.buildRealRoute = function(tLat, tLng, tName) {
        window.clearRoute();
        const roads = myData.features.filter(f => f.properties.mcType === 'road');
        const graph = {};
        
        roads.forEach(road => {
            const coords = road.geometry.coordinates;
            for (let i = 0; i < coords.length - 1; i++) {
                const p1 = `${coords[i][1]},${coords[i][0]}`, p2 = `${coords[i+1][1]},${coords[i+1][0]}`;
                const d = Math.hypot(coords[i][1]-coords[i+1][1], coords[i][0]-coords[i+1][0]);
                if (!graph[p1]) graph[p1] = {}; if (!graph[p2]) graph[p2] = {};
                graph[p1][p2] = d; graph[p2][p1] = d;
            }
        });

        const findNearestNode = (lat, lng) => {
            let min = Infinity, node = null;
            Object.keys(graph).forEach(n => {
                const [nLat, nLng] = n.split(',').map(Number);
                const d = Math.hypot(lat - nLat, lng - nLng);
                if (d < min) { min = d; node = n; }
            });
            return node;
        };

        const s = findNearestNode(userStartPoint[0], userStartPoint[1]);
        const e = findNearestNode(tLat, tLng);
        if(!s || !e) return;

        const dists = {}, prev = {}, pq = new Set(Object.keys(graph));
        Object.keys(graph).forEach(n => dists[n] = Infinity);
        dists[s] = 0;

        while(pq.size > 0) {
            let curr = null;
            pq.forEach(n => { if(!curr || dists[n] < dists[curr]) curr = n; });
            if(!curr || dists[curr] === Infinity || curr === e) break;
            pq.delete(curr);
            for(let nei in graph[curr]) {
                let alt = dists[curr] + graph[curr][nei];
                if(alt < dists[nei]) { dists[nei] = alt; prev[nei] = curr; }
            }
        }

        const path = []; let u = e;
        while(u) { path.unshift(u.split(',').map(Number)); u = prev[u]; }

        currentRoute = L.polyline([userStartPoint, ...path, [tLat, tLng]], { color: '#4285F4', weight: 5, lineJoin: 'round' }).addTo(map);
        document.getElementById('route-panel').style.display = 'block';
        document.getElementById('route-info').innerText = tName;
        map.fitBounds(currentRoute.getBounds(), { padding: [50, 50] });
    };

    // 5. –õ–û–ì–ò–ö–ê –ü–û–ò–°–ö–ê
    document.getElementById('mapSearch').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const q = e.target.value.toLowerCase().trim();
            if (!q) return;

            const f = myData.features.find(feat => 
                feat.properties.name && 
                feat.properties.name.toLowerCase().includes(q) &&
                feat.properties.name !== "."
            );

            if (f) {
                const coords = getCentroid(f);
                map.setView(coords, 2);
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
                map.eachLayer(l => {
                    if (l.feature === f) l.openPopup(coords);
                });
            } else {
                alert("–û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!");
            }
        }
    });

    // 6. –õ–û–ì–ò–ö–ê –ü–ê–ù–û–†–ê–ú
    const select = document.getElementById('locationSelect');
    PANO_SCENES.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id; opt.textContent = s.title;
        select.appendChild(opt);
    });

    function loadScene(sceneId) {
        const scene = PANO_SCENES.find(s => s.id === sceneId);
        if (!scene) return;
        if (viewer) viewer.destroy();
        viewer = pannellum.viewer('panorama', {
            type: 'cubemap',
            cubeMap: [
                scene.folder + '/panorama_0.png', scene.folder + '/panorama_1.png',
                scene.folder + '/panorama_2.png', scene.folder + '/panorama_3.png',
                scene.folder + '/panorama_4.png', scene.folder + '/panorama_5.png'
            ],
            autoLoad: true,
            showControls: true,
            hfov: 100
        });
    }

    select.addEventListener('change', (e) => loadScene(e.target.value));

    // –•–µ–ª–ø–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ü–µ–Ω—Ç—Ä–∞ –ª—é–±–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    function getCentroid(f) {
        const g = f.geometry;
        if (g.type === "Point") return [g.coordinates[1], g.coordinates[0]];
        if (g.type === "Polygon") return [g.coordinates[0][0][1], g.coordinates[0][0][0]];
        if (g.type === "LineString") return [g.coordinates[0][1], g.coordinates[0][0]];
        if (g.type === "MultiPolygon") return [g.coordinates[0][0][0][1], g.coordinates[0][0][0][0]];
        return [0, 0];
    }
</script>
</body>
</html>
